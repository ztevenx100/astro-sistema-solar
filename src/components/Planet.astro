---
import type { Planet } from '../data/planets';

export interface Props {
  planet: Planet;
  index: number;
}

const { planet, index } = Astro.props;
const delayAnimation = index * 0.5;
const startAngle = index * 45;
---

<!-- Planet wrapper container -->
<div class="planet-wrapper" data-planet-id={planet.id} data-planet-name={planet.name}>
  <!-- Planet orbit container -->
  <div 
    class="planet-orbit-container absolute"
    style={`
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    `}
  >
    <div 
      class="planet-on-orbit orbit group cursor-pointer"
      style={`
        position: absolute;
        width: ${Math.max(15, Math.min(30, planet.diameter / 5000))}px;
        height: ${Math.max(15, Math.min(30, planet.diameter / 5000))}px;
        left: ${planet.orbitRadius}px;
        top: 0;
        transform: translate(-50%, -50%) rotate(${startAngle}deg);
        transform-origin: ${-planet.orbitRadius}px 0px;
        --orbit-duration: ${planet.orbitSpeed}s;
        animation-delay: ${delayAnimation}s;
      `}
    >
      <a href={`/planets/${planet.id}`} class="block w-full h-full">
        <div 
          class={`planet relative rounded-full planet-spin w-full h-full ${planet.color === '#FDB813' ? 'glow-yellow' : planet.color === '#6B93D6' ? 'glow-blue' : planet.color === '#CD5C5C' ? 'glow-red' : 'glow-purple'}`}
          style={`
            background: linear-gradient(135deg, ${planet.color}dd 0%, ${planet.color} 50%, ${planet.color}aa 100%);
            --spin-duration: ${planet.rotationPeriod > 0 ? Math.abs(planet.rotationPeriod) / 100 : 10}s;
            animation-direction: ${planet.rotationPeriod < 0 ? 'reverse' : 'normal'};
            box-shadow: 0 0 15px ${planet.color}66;
          `}
        >
          <div class="absolute inset-0 rounded-full opacity-40">
            <div class="w-full h-full rounded-full bg-gradient-to-br from-white via-transparent to-transparent"></div>
          </div>
          
          <div class="absolute inset-0 rounded-full">
            <div class="w-full h-full rounded-full bg-gradient-to-l from-black via-transparent to-transparent opacity-20"></div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <div 
    class="planet-info planet-tooltip glass-effect rounded-lg p-3 opacity-0 transition-all duration-300 z-30 pointer-events-none"
    data-planet-tooltip={planet.id}
  >
    <h3 class="font-space font-bold text-star text-sm mb-1">{planet.name}</h3>
    <div class="text-xs space-y-1">
      <p class="text-gray-300">Distancia: {planet.distanceFromSun.toLocaleString()} millones km</p>
      <p class="text-gray-400">Lunas: {planet.moons}</p>
      <p class="text-gray-400">Año: {planet.orbitalPeriod} días terrestres</p>
    </div>
    <div class="text-xs text-blue-300 mt-2 font-medium">Clic para explorar</div>
    <div class="tooltip-arrow"></div>
  </div>
</div>

<style>
  .planet-wrapper {
    position: static;
    pointer-events: none;
  }
  
  .planet-orbit-container {
    pointer-events: none;
  }
  
  .planet-on-orbit {
    pointer-events: auto;
  }
  
  .planet-info {
    position: fixed;
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    border: 2px solid #4299e1;
    backdrop-filter: blur(10px);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1000;
    min-width: 160px;
    max-width: 220px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
    white-space: nowrap;
  }

  /* Flecha del tooltip */
  .tooltip-arrow {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #4299e1;
  }

  /* Mostrar tooltip en hover */
  .planet-on-orbit:hover .planet-tooltip {
    opacity: 1 !important;
  }
  
  .planet:hover {
    filter: brightness(1.2);
  }
  
  /* Glow effects for different planet types */
  .glow-yellow {
    box-shadow: 0 0 20px #ffd70066;
  }
  
  .glow-blue {
    box-shadow: 0 0 20px #6b93d666;
  }
  
  .glow-red {
    box-shadow: 0 0 20px #cd5c5c66;
  }
  
  .glow-purple {
    box-shadow: 0 0 20px #9966cc66;
  }
  
  /* Responsive planet sizes */
  @media (max-width: 768px) {
    .planet-orbit-container {
      transform: translate(-50%, -50%) scale(0.8) rotate(var(--start-angle, 0deg));
    }
    
    .planet-info {
      min-width: 150px;
      max-width: 200px;
      font-size: 0.7rem;
    }
  }
  
  @media (max-width: 480px) {
    .planet-orbit-container {
      transform: translate(-50%, -50%) scale(0.6) rotate(var(--start-angle, 0deg));
    }
    
    .planet-info {
      min-width: 120px;
      max-width: 180px;
      font-size: 0.65rem;
    }
    
    .planet-info p,
    .planet-info div {
      white-space: normal;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const planetWrappers = document.querySelectorAll('.planet-wrapper');
    
    planetWrappers.forEach((wrapper) => {
      const planetElement = wrapper.querySelector('.planet') as HTMLElement;
      const tooltip = wrapper.querySelector('.planet-tooltip') as HTMLElement;
      const planetContainer = wrapper.querySelector('.planet-on-orbit') as HTMLElement;
      
      if (planetElement && tooltip && planetContainer) {
        
        // Función para posicionar el tooltip
        const positionTooltip = () => {
          const planetRect = planetElement.getBoundingClientRect();
          const planetName = wrapper.getAttribute('data-planet-name');
          console.log(`Planet: ${planetName}, Rect:`, planetRect);

          const tooltipX = planetRect.left-570;
          const tooltipY = planetRect.top-100;
          
          tooltip.style.left = `${tooltipX}px`;
          tooltip.style.top = `${tooltipY}px`;
          tooltip.style.transform = 'translate(150%, 150%)';
        };
        
        planetContainer.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
          positionTooltip();
          
          const updatePosition = () => {
            if (tooltip.style.opacity === '1') {
              positionTooltip();
              requestAnimationFrame(updatePosition);
            }
          };
          requestAnimationFrame(updatePosition);
        });
        
        // Ocultar tooltip
        planetContainer.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
        });
        
        // Reposicionar en resize
        window.addEventListener('resize', () => {
          if (tooltip.style.opacity === '1') {
            positionTooltip();
          }
        });
      }
    });
  });
</script>
